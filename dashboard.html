<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bhojan Valley Admin Panel</title>
    <link href="./dist/output.css" rel="stylesheet">
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getDatabase, ref, onValue, update, push, remove } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDEO4lgBPbqm2au8jn42ZK-qQVehtcPNmg",
            authDomain: "bhojanvalley-ce400.firebaseapp.com",
            databaseURL: "https://bhojanvalley-ce400-default-rtdb.firebaseio.com",
            projectId: "bhojanvalley-ce400",
            storageBucket: "bhojanvalley-ce400.firebasestorage.app",
            messagingSenderId: "834947885728",
            appId: "1:834947885728:web:5b1f562dd0bc04f1cab7c5",
            measurementId: "G-4PTSESNV53"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        // Check authentication state
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = 'index.html';
            }
        });

        // Logout function
        window.logout = function() {
            signOut(auth).then(() => {
                window.location.href = 'index.html';
            });
        };

        // Load analytics (total orders and revenue)
        function loadAnalytics() {
            const ordersRef = ref(db, 'orders');
            onValue(ordersRef, (snapshot) => {
                const orders = snapshot.val();
                let totalOrders = 0;
                let totalRevenue = 0;

                if (orders) {
                    totalOrders = Object.keys(orders).length;
                    totalRevenue = Object.values(orders).reduce((sum, order) => {
                        const orderTotal = order.items?.reduce((total, item) => total + (item.price * item.quantity), 0) || 0;
                        return sum + orderTotal;
                    }, 0);
                }

                document.getElementById('totalOrders').textContent = `Total Orders: ${totalOrders}`;
                document.getElementById('totalRevenue').textContent = `Total Revenue: â‚¹${totalRevenue.toFixed(2)}`;
            });
        }

        // Load orders
        function loadOrders() {
            const ordersRef = ref(db, 'orders');
            onValue(ordersRef, (snapshot) => {
                const orders = snapshot.val();
                const ordersList = document.getElementById('ordersList');
                ordersList.innerHTML = '';

                if (!orders) {
                    ordersList.innerHTML = '<p>No orders available.</p>';
                    return;
                }

                Object.keys(orders).forEach((orderId) => {
                    const order = orders[orderId];
                    const orderDiv = document.createElement('div');
                    orderDiv.className = 'border p-4 mb-2 rounded';
                    orderDiv.innerHTML = `
                        <p><strong>Order ID:</strong> ${orderId}</p>
                        <p><strong>Customer:</strong> ${order.customer?.name || 'N/A'}</p>
                        <p><strong>Items:</strong> ${order.items?.map(item => `${item.name} (x${item.quantity})`).join(', ')}</p>
                        <p><strong>Status:</strong>
                            <select id="status-${orderId}" onchange="updateOrderStatus('${orderId}', this.value)" class="border p-1 rounded">
                                <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                                <option value="preparing" ${order.status === 'preparing' ? 'selected' : ''}>Preparing</option>
                                <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                                <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                            </select>
                        </p>
                        <button onclick="deleteOrder('${orderId}')" class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">Delete</button>
                    `;
                    ordersList.appendChild(orderDiv);
                });
            });
        }

        // Update order status
        window.updateOrderStatus = function(orderId, status) {
            const orderRef = ref(db, `orders/${orderId}`);
            update(orderRef, { status })
                .then(() => console.log('Order status updated'))
                .catch((error) => console.error('Error updating status:', error));
        };

        // Delete order
        window.deleteOrder = function(orderId) {
            if (confirm('Are you sure you want to delete this order?')) {
                const orderRef = ref(db, `orders/${orderId}`);
                remove(orderRef)
                    .then(() => console.log('Order deleted'))
                    .catch((error) => console.error('Error deleting order:', error));
            }
        };

        // Update menu item price
        window.updatePrice = function(event) {
            event.preventDefault();
            const itemName = document.getElementById('updateItemName').value;
            const newPrice = parseFloat(document.getElementById('newPrice').value);
            const updateMessage = document.getElementById('updateMessage');
            const updateError = document.getElementById('updateError');

            if (!itemName || isNaN(newPrice) || newPrice <= 0) {
                updateError.classList.remove('hidden');
                updateMessage.classList.add('hidden');
                return;
            }

            const menuRef = ref(db, 'menu');
            onValue(menuRef, (snapshot) => {
                const menuItems = snapshot.val();
                if (!menuItems) {
                    updateError.classList.remove('hidden');
                    updateMessage.classList.add('hidden');
                    return;
                }

                const itemId = Object.keys(menuItems).find(id => menuItems[id].name === itemName);
                if (itemId) {
                    const itemRef = ref(db, `menu/${itemId}`);
                    update(itemRef, { price: newPrice })
                        .then(() => {
                            updateMessage.classList.remove('hidden');
                            updateError.classList.add('hidden');
                            document.getElementById('updatePriceForm').reset();
                        })
                        .catch((error) => {
                            updateError.classList.remove('hidden');
                            updateMessage.classList.add('hidden');
                            console.error('Error updating price:', error);
                        });
                } else {
                    updateError.classList.remove('hidden');
                    updateMessage.classList.add('hidden');
                }
            }, { onlyOnce: true });
        };

        // Add menu item
        window.addItem = function(event) {
            event.preventDefault();
            const itemName = document.getElementById('itemName').value;
            const itemPrice = parseFloat(document.getElementById('itemPrice').value);
            const itemCategory = document.getElementById('itemCategory').value;
            const addMessage = document.getElementById('addMessage');
            const addError = document.getElementById('addError');

            if (!itemName || isNaN(itemPrice) || itemPrice <= 0 || !itemCategory) {
                addError.classList.remove('hidden');
                addMessage.classList.add('hidden');
                return;
            }

            const menuRef = ref(db, 'menu');
            onValue(menuRef, (snapshot) => {
                const menuItems = snapshot.val();
                if (menuItems && Object.values(menuItems).some(item => item.name === itemName)) {
                    addError.classList.remove('hidden');
                    addMessage.classList.add('hidden');
                    return;
                }

                push(menuRef, { name: itemName, price: itemPrice, category: itemCategory })
                    .then(() => {
                        addMessage.classList.remove('hidden');
                        addError.classList.add('hidden');
                        document.getElementById('addItemForm').reset();
                    })
                    .catch((error) => {
                        addError.classList.remove('hidden');
                        addMessage.classList.add('hidden');
                        console.error('Error adding item:', error);
                    });
            }, { onlyOnce: true });
        };

        // Load menu items
        function loadMenu() {
            const menuRef = ref(db, 'menu');
            onValue(menuRef, (snapshot) => {
                const menuItems = snapshot.val();
                const updateItemName = document.getElementById('updateItemName');
                updateItemName.innerHTML = '<option value="">Select Item</option>';

                if (menuItems) {
                    Object.entries(menuItems).forEach(([id, item]) => {
                        const option = document.createElement('option');
                        option.value = item.name;
                        option.textContent = item.name;
                        updateItemName.appendChild(option);
                    });
                }
            });
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            loadAnalytics();
            loadOrders();
            loadMenu();
        });
    </script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4">
        <h1 class="text-3xl font-bold mb-4">Bhojan Valley Admin Panel</h1>
        <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 mb-4">Logout</button>

        <div class="bg-white p-4 rounded shadow mb-6">
            <h2 class="text-2xl font-semibold mb-4">Analytics</h2>
            <p id="totalOrders" class="text-lg">Total Orders: 0</p>
            <p id="totalRevenue" class="text-lg">Total Revenue: â‚¹0</p>
        </div>

        <div class="bg-white p-4 rounded shadow mb-6">
            <h2 class="text-2xl font-semibold mb-4">Menu Management</h2>
            <div class="mb-4">
                <h3 class="text-xl font-medium mb-2">Update Price</h3>
                <div id="updatePriceForm" class="space-y-2" onsubmit="updatePrice(event)">
                    <select id="updateItemName" class="border p-2 rounded w-full">
                        <option value="">Select Item</option>
                    </select>
                    <input id="newPrice" type="number" step="0.01" placeholder="New Price" class="border p-2 rounded w-full">
                    <button type="submit" onclick="document.getElementById('updatePriceForm').dispatchEvent(new Event('submit'))" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Update Price</button>
                    <p id="updateMessage" class="text-green-500 hidden">Price updated!</p>
                    <p id="updateError" class="text-red-500 hidden">Item not found or invalid price.</p>
                </div>
            </div>
            <div>
                <h3 class="text-xl font-medium mb-2">Add Item</h3>
                <div id="addItemForm" class="space-y-2" onsubmit="addItem(event)">
                    <input id="itemName" type="text" placeholder="Item Name" class="border p-2 rounded w-full">
                    <input id="itemPrice" type="number" step="0.01" placeholder="Price" class="border p-2 rounded w-full">
                    <select id="itemCategory" class="border p-2 rounded w-full">
                        <option value="Veg">Veg</option>
                        <option value="Non-Veg">Non-Veg</option>
                        <option value="Fast Food">Fast Food</option>
                    </select>
                    <button type="submit" onclick="document.getElementById('addItemForm').dispatchEvent(new Event('submit'))" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Add Item</button>
                    <p id="addMessage" class="text-green-500 hidden">Item added!</p>
                    <p id="addError" class="text-red-500 hidden">Item exists or invalid input.</p>
                </div>
            </div>
        </div>

        <div class="bg-white p-4 rounded shadow">
            <h2 class="text-2xl font-semibold mb-4">Orders</h2>
            <div id="ordersList">
                <p>No orders available.</p>
            </div>
        </div>
    </div>
</body>
</html>
